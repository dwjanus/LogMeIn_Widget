<div class="container" id="widget" style="visibility: visible;">
    <div name="logmein">
        <div class="form-header">
            <h2>LogMeIn Remote Session</h2>
        </div>
        
        <div id="logmein_form">
            <form id="logmein_auth">
                <div class="form-field">
                    <input type="email" id="email" name="email" placeholder="Rescue Username" onFocus="this.placeholder=''" onblur="this.placeholder='Email'" />
                    <input type="password" id="pw" name="pw" placeholder="Rescue Password" onFocus="this.placeholder=''" onblur="this.placeholder='Password'" />
                </div>
            </form>

            <div>
                <button type="submit" class="btn" form="logmein_auth">Create Session</button>
                <button type="button" class="btn" id="hidebtn" onclick="platformWidgetHelper.hide()">Hide Widget</button>
            </div>
        </div>
    </div>
</div>

<div>{{ data }}</div>


<script>
  setlocal = (response) => {
    console.log('local storage set: ' + JSON.stringify(response))
  }

  contextRecievedHandler = (response) => {
    if (response.context_type == 'Incident') {
      console.log('Context type is incident --> calling show()')
      platformWidgetHelper.show()
    }
  }

  platformWidgetHelper.getContextObject(contextRecievedHandler)

  document.getElementById("logmein_auth").addEventListener("submit", logmein)

  function logmein(event) {
    event.preventDefault()
    console.log('>>> logmein() called')
    var email = document.getElementById("email").value
    var pw = document.getElementById("pw").value
    var url = `https://secure.logmeinrescue.com/api/requestAuthCode.aspx?email=${email}&pwd=${pw}`


    getAuth(url)
      .then(getPin)
      .then(postComment)
      .catch(e => console.log(`> Error: ${e}`))
  }

  function getAuth(url) {
    console.log('>>> retrieving logmein authcode')
    return fetch(url).then((res) => {
      return res.text()
    }).then((data) => {
      var code = data.split('AUTHCODE:')[1]
      return code
    }).catch((err) => {
      console.log(`Error! >> ${err}`)
    })
  }

  function getPin(code) {
    var url = `https://secure.logmeinrescue.com/api/requestPINCode.aspx?notechconsole=1&authcode=${code}`

    return fetch(url).then((res) => {
      console.log('>>> requesting pin')
      return res.text()
    }).then((data) => {
      var pin = data.split('PINCODE:')[1]
      return pin
    }).catch((err) => {
      console.log(`Error! >> ${err}`)
    })
  }

  function postComment(pin) {
    var link = `https://secure.logmeinrescue.com/R?i=2&Code=${pin}`
    var click = "window.open('" + link + "', '_blank')"
    var id

    platformWidgetHelper.getContextObject((incident) => id = incident.context_id)

    var comment_json = {
      comment: {
        body: `Go here to launch your Rescue session: ${link}`,
        is_private: false
      }
    }

    console.log(`>>> incident id: ${id} retrieved from context handler`)
    console.log(`>>> about to post comment: ${JSON.stringify(comment_json)}`)

    platformWidgetHelper.callSamanageAPI((response) => {
      console.log('>>> Samanage API response:\n' + response)
    }, 'POST', `https://api.samanage.com/incidents/${id}/comments.json`, JSON.stringify(comment_json))
  
    var form = document.getElementById('logmein_form')
    var success = document.createElement('div')
    success.innerHTML = `
      <div class="success">
          <p id="success">Success!</p> 
          <p style="font-size: 12px; margin-top: 5px;">Your session Pin is:</p>
          <p id="pin">${pin}</p>
      </div>
      <div style="padding-top: 15px;">
          <button type="button" class="btn" id="session" onclick="${click}">
              Go to Session
          </button>
      </div>
    `
    form.parentNode.replaceChild(success, form)
  }
</script>

