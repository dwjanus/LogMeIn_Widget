<div class="container" id="tv_widget" style="visibility: visible;">
    <div name="teamviewer" id="teamviewer">
        <div class="form-header">
            <h2>TeamViewer Remote Session</h2>
        </div>

        <div class="session_code" style="display: inline-block; width: 220px; margin: 5px;">
            <label style="float: left;">Session Code:</label> 
            <p id="code"></p>
        </div>

        <div class="customer_link" style="display: inline-block; width: 220px; margin: 5px;">
            <label style="float: left;">Customer Link:</label> 
            <p id="customer_link"></p>
        </div>

        <div class="tech_link" style="display: inline-block; width: 220px; margin: 5px;">
            <label style="float: left;">Supporter Link:</label> 
            <p id="tech_link"></p>
        </div>

        <!-- <div style="padding-top: 15px;">
            <button type="button" class="btn" id="insert" onclick="">
                Insert Link
            </button>
        </div>

        <div style="padding-top: 15px;">
            <button type="button" class="btn" id="connect" onclick="">
                Connect to Session
            </button>
        </div> -->
    </div>
</div>

<script>
  var context
  var oauthParams
  
  setlocal = (response) => {
    console.log('local storage set: ' + JSON.stringify(response))
  }

  contextRecievedHandler = (response) => {
    if (response.context_type == 'Incident') {
      console.log('Context type is incident --> calling show()')
      context = response
      platformWidgetHelper.show()
    }
  }

  platformWidgetHelper.getContextObject(contextRecievedHandler)

  fetch('/tv/data')
    .then((res) => res.json())
    .then((data) => {
      context['tv_data'] = data
      console.log('>> context object:\n' + JSON.stringify(context))
      if (!document.getElementById('code').value) createSession()
    })
  .catch(e => console.log(`>> ERROR >> ${e}`))
  
  function setOauthParams(oauthParamsPassed) {
    console.log(`>>> oauth params passed to tv.html: ${JSON.stringify(oauthParamsPassed)}`)
    oauthParams = oauthParamsPassed
    // setlocal storage with oauth params
  }

  function createSession() {
    let body_json = {
      description: context.description,
      end_customer: {
        name: context.requester.name
      },
      custom_api: { "incident_id": context.context_id }
    }

    fetch('https://webapi.teamviewer.com/api/v1/sessions', {
      method: 'POST',
      headers: { 
        'Authorization': `Bearer ${oauthParams.access_token}`,
        'Content-Type': 'application/json', 
      },
      body: JSON.stringify(body_json),
      mode: 'cors'
    }).then((res) => res.json())
      .then((data) => {
        console.log(`>>> response data: ${JSON.stringify(data)}`)
        document.getElementById('code').value = data.code
        document.getElementById('customer_link').value = data.end_customer_link
        document.getElementById('tech_link').value = data.supporter_link
      })
    .catch(e => console.log(e))
  }

</script>



